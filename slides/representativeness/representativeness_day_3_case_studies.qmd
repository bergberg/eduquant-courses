---
title: "Representativeness"
subtitle: "Day 3 (case studies)"
author: "Pieter van den Berg"
date: 2023-10-17
date-format: long
format: eduquant-slides-revealjs
---


# Case Studies

## Case study 3: acceptance policy change {.smaller .r-fit-text auto-animate=true}


#### Introduction


In this exercise, you will **estimate an appropriate adjustment and MoC A** to account for the bias introduced by having a **non-comparable acceptance policy** applied for exposures over part of the historical data set. 

```{r setup}
library(dplyr)
library(ggplot2)
library(ggblend)
library(patchwork)
library(ggrepel)
library(latex2exp)
source("../../Rscripts/utils.R")
cred_sim <- vroom::vroom("../../media/cred_sim.csv.gz")
cred_sim_acc <- vroom::vroom("../../media/cred_sim_acc.csv.gz")
cred_sim_acc_aggr_dr <- vroom::vroom("../../media/cred_sim_acc_aggr_dr.csv.gz")

t_acc_policy_change <- 70L


bg <- 'transparent'
ggtheme <- theme_minimal()+theme(
                           panel.background = element_rect(fill=bg, linetype = "blank"), 
                           plot.background = element_rect(fill=bg, color=NA), 
                           panel.grid.major = element_blank(), 
                           panel.grid.minor = element_blank(), 
                           legend.background = element_rect(fill=bg, linetype = "blank"), 
                           legend.box.background = element_rect(fill=bg, linetype = "blank"),
                           legend.position = "bottom",
                           legend.text = element_text(size=10),
                           legend.title = element_text(size=9)
                           )


```


 * Download the dataset from the slides website (`csv` or `xlsx`)
 * Use your favorite tool! Anything goes.
 * Bring the results for discussion to the next training
 * Or send them to [pieter@berg-sp.eu](mailto:pieter@berg-sp.eu)

## Case study 3: acceptance policy change {.smaller .r-fit-text auto-animate=true}
:::: columns

::: {.column #vcenter width="50%" .r-fit-text }


#### Description

 * One homogeneous portfolio, one DoD, two acceptance policies $U,V$
 * Acceptance policy change at $t_{\text{change}} = 70$
$$\text{acc_policy}(t_0): \begin{align*} t_0<t_{\text{change}} &=  U \\ t_0\ge t_{\text{change}} &=  V \end{align*}$$

 * $U,V$ apply a different threshold $a_0>\Delta_{\text{acc_policy}(t_0)}$

#### Assignment

 * Estimate an appropriately adjusted long-run average default rate and MoC A
 * Bonus points: repeat, but this time ignore `a0`

::: 

::: {.column #vcenter width="50%" .r-fit-text }
```{r plot}
#| dev.args:
#|   bg: "transparent"
#| fig.asp: 1
#| fig.width: 5
#| 

ggplot2::theme_set(ggtheme)
p1 <- cred_sim_acc_aggr_dr |> 
  filter(accepted=="Any", acc_policy=="Any") |>
  ggplot_rate_series(name = dr, alpha = 0.33) +
  geom_vline(xintercept = t_acc_policy_change, linewidth=0.25, linetype = "dashed") +
  labs(caption = "accepted + rejected")

p2 <- cred_sim_acc_aggr_dr |> 
  filter(accepted=="accepted", acc_policy=="Any") |>
  ggplot_rate_series(name = dr, alpha = 0.33) +
  geom_vline(xintercept = t_acc_policy_change, linewidth=0.25, linetype = "dashed") +
  labs(caption = "accepted only, any policy")

p3 <- cred_sim_acc_aggr_dr |> 
  filter(accepted=="accepted", acc_policy!="Any") |>
  group_by(acc_policy) |> 
  ggplot_rate_series(name = dr, alpha = 0.33) +
  coord_cartesian(ylim=c(0,0.05)) + 
  geom_vline(xintercept = t_acc_policy_change, linewidth=0.25, linetype = "dashed") +
  labs(caption = "accepted only, per policy") +
  theme(legend.title=element_blank()) 

(p1+p2)/p3

```
:::

::::


## Case study 3: acceptance policy change  {.smaller .r-fit-text auto-animate=true}


:::: columns
::: {.column width="50%" .r-fit-text }


| column    | description    |
|-------------|-------------|
|`i`| exposure id|
|`t`| time|
|`d`| in-default|
|`into_d_12`| into default within 12 months|
|`status`| `enter`, `stock`, `default` or `exit`|
|`m`|time since origination|
|`t0`| t of origination|
|`a0`| debt service to income at origination score|
|`acc_policy`| `U` or `V`|

:::
::: {.column width="50%" .r-fit-text .smaller}

```{r}
case_study_3_data <- readr::read_csv("../../media/case_study_3_data.csv.gz")
``` 

```{r echo=FALSE}
#| tbl-cap: "sample of 10 exposures" 

case_study_3_data |>
  filter(i %in% sample(i,10)) |> 
  as.data.frame()
```
[ [link to xlsx]{.underline}](/media/case_study_2_data.xlsx)

[ [link to csv.gz]{.underline}](/media/case_study_2_data.csv.gz)
:::
::::



## Case study 4: Two DoD {.smaller .r-fit-text auto-animate=true}

```{r setup2}
case_study_4_data <- readr::read_csv("../../media/case_study_4_data.csv.gz")
```
#### Introduction

In this exercise, you will estimate an **appropriate adjustment** and **MoC A** to account for a difference between the `implemented` DoD used in application and the `simulated` DoD available in historical data. 

Fortunately, some data is available that was collected under the new definition. 

This is a (simulated) data set of a homogeneous portfolio, and there are no risk drivers, grades or other features to distinguish the exposures by. Lucky you!

## Case study 4: Two DoD {.smaller .r-fit-text auto-animate=true}
:::: columns

::: {.column #vcenter width="50%" .r-fit-text }


#### Description

 * One homogeneous portfolio
 * `simulated` DoD available in historical data
 * `implemented` DoD available for $t \ge 95$



#### Assignment

 * Estimate an appropriately adjusted long-run average default rate
 * Bonus Points: calculate a MoC A
 
::: 

::: {.column #vcenter width="50%" .r-fit-text }
```{r plot2}
#| dev.args:
#|   bg: "transparent"
#| fig.asp: 1
#| fig.width: 5 
#|  

ggplot2::theme_set(ggtheme)
case_study_4_data |> filter(!d) |> group_by(DoD) |>
    summarise_binom_rate_ci(indicator = into_d_12,t=t,name=dr,ci_fun=binom::binom.exact,conf.level = 0.68,n_overlap=12) |> 
    ggplot_rate_series(name=dr)

```
:::

::::


## Case study 4: Two DoD {.smaller .r-fit-text auto-animate=true}


:::: columns
::: {.column width="50%" .r-fit-text }


| column    | description    |
|-------------|-------------|
|`i`| exposure id|
|`t`| time|
|`DoD`| `simulated` or `implemented`|
|`d`| in-default|
|`into_d_12`| into default within 12 months|
|`status`| `enter`, `stock`, `default` or `exit`|


:::
::: {.column width="50%" .r-fit-text .smaller}

```{r}
case_study_4_data <- readr::read_csv("../../media/case_study_4_data.csv.gz")
``` 

```{r echo=FALSE}
#| tbl-cap: "sample of 10 exposures" 

case_study_4_data |>
  filter(i %in% sample(i,10)) |> 
  as.data.frame()
```
[ [link to xlsx]{.underline}](/media/case_study_4_data.xlsx)

[ [link to csv.gz]{.underline}](/media/case_study_4_data.csv.gz)
:::
::::


## Case study 5: acceptance policy change (hard mode) {.smaller .r-fit-text auto-animate=true}


#### Introduction


In this exercise, you will **estimate an appropriate adjustment and MoC A** to account for the bias introduced by having a **non-comparable acceptance policy** applied for exposures over part of the historical data set. 

[Hard mode unlocked!]{style="color:red"}

```{r setup3}
cred_sim2 <- vroom::vroom("../../media/cred_sim2.csv.gz")
cred_sim_acc2 <- vroom::vroom("../../media/cred_sim_acc2.csv.gz")
cred_sim_acc_aggr_dr2 <- vroom::vroom("../../media/cred_sim_acc_aggr_dr2.csv.gz")

```

## Case study 5: acceptance policy change (hard mode) {.smaller .r-fit-text auto-animate=true}
:::: columns

::: {.column #vcenter width="50%" .r-fit-text }


#### Description

 * One homogeneous portfolio, one DoD, two acceptance policies $U,V$
 * Acceptance policy change at $t_{\text{change}} = 70$
$$\text{acc_policy}(t_0): \begin{align*} t_0<t_{\text{change}} &=  U \\ t_0\ge t_{\text{change}} &=  V \end{align*}$$

 * $U,V$ apply a different threshold $a_0>\Delta_{\text{acc_policy}(t_0)}$

#### Assignment

 * By simply looking at the default rate plots, can you tell why this exercise is harder?
 * Estimate an appropriately adjusted long-run average default rate + MoC A

::: 

::: {.column #vcenter width="50%" .r-fit-text }
```{r plot4}
#| dev.args:
#|   bg: "transparent"
#| fig.asp: 1
#| fig.width: 5
#| 

ggplot2::theme_set(ggtheme)
p1 <- cred_sim_acc_aggr_dr2 |> 
  filter(accepted=="Any", acc_policy=="Any") |>
  ggplot_rate_series(name = dr, alpha = 0.33) +
  geom_vline(xintercept = t_acc_policy_change, linewidth=0.25, linetype = "dashed") +
  labs(caption = "accepted + rejected")

p2 <- cred_sim_acc_aggr_dr2 |> 
  filter(accepted=="accepted", acc_policy=="Any") |>
  ggplot_rate_series(name = dr, alpha = 0.33) +
  geom_vline(xintercept = t_acc_policy_change, linewidth=0.25, linetype = "dashed") +
  labs(caption = "accepted only, any policy")

p3 <- cred_sim_acc_aggr_dr2 |> 
  filter(accepted=="accepted", acc_policy!="Any") |>
  group_by(acc_policy) |> 
  ggplot_rate_series(name = dr, alpha = 0.33) +
  coord_cartesian(ylim=c(0,0.1)) + 
  geom_vline(xintercept = t_acc_policy_change, linewidth=0.25, linetype = "dashed") +
  labs(caption = "accepted only, per policy") +
  theme(legend.title=element_blank()) 

(p1+p2)/p3

```
:::

::::


## Case study 5: acceptance policy change (hard mode) {.smaller .r-fit-text auto-animate=true}


:::: columns
::: {.column width="50%" .r-fit-text }


| column    | description    |
|-------------|-------------|
|`i`| exposure id|
|`t`| time|
|`d`| in-default|
|`into_d_12`| into default within 12 months|
|`status`| `enter`, `stock`, `default` or `exit`|
|`m`|time since origination|
|`t0`| t of origination|
|`a0`| debt service to income at origination score|
|`acc_policy`| `U` or `V`|

:::
::: {.column width="50%" .r-fit-text .smaller}

```{r}
case_study_5_data <- readr::read_csv("../../media/case_study_5_data.csv.gz")
``` 

```{r echo=FALSE}
#| tbl-cap: "sample of 10 exposures" 

case_study_5_data |>
  filter(i %in% sample(i,10)) |> 
  as.data.frame()
```
[ [link to xlsx]{.underline}](/media/case_study_5_data.xlsx)

[ [link to csv.gz]{.underline}](/media/case_study_5_data.csv.gz)
:::
::::

